$(function(){function e(){function e(){var e={center:y,zoom:14,minZoom:3,maxZoom:18,disableDefaultUI:!0};f=new google.maps.Map(document.getElementById("map-canvas"),e),m=new google.maps.InfoWindow({pixelOffset:new google.maps.Size(-23,-10)}),b=google.maps.Animation.DROP,v=new google.maps.StyledMapType(styles,{name:"Styled Map"}),f.mapTypes.set("map_style",v),f.setMapTypeId("map_style")}function n(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){y={lat:e.coords.latitude,lng:e.coords.longitude},f.setCenter(y),o(y)},function(){t(!0,m,f.getCenter())}):(t(!1,m,f.getCenter()),o(y))}function t(e,n,t){o(y)}function o(e){w.nearByPlaces([]);var n=new google.maps.places.PlacesService(f);n.nearbySearch({location:e,radius:w.radius(),types:k},i)}function i(e,n,t){var o=new google.maps.LatLngBounds;if(n===google.maps.places.PlacesServiceStatus.OK){for(var i,a=0;i=e[a];a++)"political"!=i.types[i.types.length-1]&&(w.nearByPlaces.push(i),o.extend(i.geometry.location));f.fitBounds(o),k=[]}}function a(){function e(){var e=t.getPlaces();if(w.places(e),0!==w.places().length){if(1==w.places().length)o(w.places()[0].geometry.location),w.nearByPlaces().push(e[0]);else{var n=new google.maps.LatLngBounds;w.places().forEach(function(e){n.extend(e.geometry.location),f.fitBounds(n)})}document.getElementById("search-input").value="",w.keyword(""),b=google.maps.Animation.DROP}}w.places([]);var n=document.getElementById("search-input"),t=new google.maps.places.SearchBox(n);f.addListener("bounds_changed",function(){t.setBounds(f.getBounds()),y=f.getCenter()}),t.addListener("places_changed",e),k=[]}function s(e){var n=Math.sqrt($(window).width())+20;w.markers().forEach(function(e){e.setMap(null)}),w.markers([]),e.forEach(function(e){var t={url:e.icon,size:new google.maps.Size(n,n),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(n/4,n/2),scaledSize:new google.maps.Size(n/2.8,n/2.8)},o=new google.maps.Marker({map:f,icon:t,title:e.name,animation:b,position:e.geometry.location}),i=(window.innerWidth,window.innerHeight);o.addListener("click",function(){w.markers().forEach(function(e){e.setAnimation(null)}),null!==o.getAnimation()?o.setAnimation(null):(o.setAnimation(google.maps.Animation.BOUNCE),f.panTo(o.position),f.panBy(-20,-1*(i/2-100)))}),w.markers().push(o),google.maps.event.addListener(o,"click",function(){r(e,o)})})}function r(e,n){var t=new google.maps.places.PlacesService(f),o=200;$(window).width()<800&&(o=170),t.getDetails({placeId:e.place_id},function(e,t){if(u(e),t===google.maps.places.PlacesServiceStatus.OK){m.setContent('<div id="infoWindow" style="width: '+o+'px; font-size: 14px; display: none;"><p><h3>'+e.name+'</h3></p><hr><p><span style="font-size: 14px">'+e.formatted_address+'</span></p><p><span style="color: #4a7ea7; font-weight: bold;">'+l(e)+'</span></p><br><div id="wiki" style="white-space: normal;"><span></span></div><hr style="background: #d2d1d1;">'+c(e)+"<p><span>"+p(e)+'</span></p><p><div class="longtext"><a href="'+d(e)+'" target="_blank">'+d(e)+"<a></div>"+g(e)+"</div></p>"),m.open(f,n),$("#infoWindow").fadeIn(1e3),w.placePhotos(e.photos),document.getElementById("photoLink").addEventListener("click",function(){function n(e){i+=e,0===i?($("#prev").hide(),$("#next").show()):i==o-1?$("#next").hide():($("#prev").show(),$("#next").show()),$("#frame").children().eq(i-e).hide(),$("#frame").children().eq(i).show(),t()}function t(){$("#photoCounter").text(i+1+" / "+o)}$("#photoViewer").show();var o=e.photos.length,i=0;n(0),$("#next").click(function(){n(1)}),$("#prev").click(function(){n(-1)}),$("#close-photo").click(function(){$("#frame").children().hide(),$("#photoViewer").hide(),i=0})});var i=document.getElementById("reviewlink");i&&i.addEventListener("click",function(){w.placeReviews([]),w.placeInFocus(e);var n=[];e.reviews.forEach(function(e){""!==e.text&&n.push(e)}),w.placeReviews(n),$("#review-page").show(),$("#reviews").children().show(),$("#close-review").click(function(){$("#reviews").children().hide(),$("#review-page").hide()})})}}),google.maps.event.addListener(m,"closeclick",function(){w.markers().forEach(function(e){e.setAnimation(null)})})}function l(e){return e.opening_hours?e.opening_hours.weekday_text[today.getDay()-1]:""}function c(e){var n="",t=w.rateImg(e);if(e.rating){n='<div><span style="color: #df6d15; padding-right: 3px;">'+e.rating+"</span>";for(var o in t)o&&(n+='<img class="rate-star" src="'+t[o].star+'" />');return n+'<a id="reviewlink" style="padding-left: 15px;" href="#"">reviews</a></div>'}return'<span style="font-style: italic;">no rating available</span>'}function p(e){return e.international_phone_number?e.international_phone_number:"<span>Location:"+e.geometry.location+"</span>"}function d(e){return e.website?e.website:""}function g(e){return e.photos&&e.photos.length>1?'<a id="photoLink" href="#"">photos<a>':'<div id="photoLink"></div>'}function u(e){var n=e.name.replace(/[\s,]/g,"%20"),t="https://en.wikipedia.org/w/api.php?format=json&action=query&prop=extracts&exintro=&explaintext=&titles="+n,o=setTimeout(function(){console.log("Wiki API failed to load.")},3e3);$.ajax({url:t,dataType:"jsonp",success:function(e){var n=document.getElementById("wiki");for(var t in e.query.pages)void 0===e.query.pages[t].extract||""===e.query.pages[t].extract||(n.innerHTML="<span>"+e.query.pages[t].extract.substring(0,60)+'...</span><a style="display: block;" href=http://en.wikipedia.org/?curid='+e.query.pages[t].pageid+' target="_blank">read more on wikipedia</a>');clearTimeout(o)}})}function h(e){var n=$(".infolist"),t=$(".infolist").scrollLeft(),o=parseInt(t/(x-26));placeCount=$(".infolist").children("li").length,o+=e,n.animate({scrollLeft:o*x-26*o},1e3)}var f,m,v,w=this,y={lat:42.3601,lng:-71.0589},k=[],b=null;today=new Date;var x=$(window).width();w.nearByPlaces=ko.observableArray([]),w.places=ko.observableArray([]),w.markers=ko.observableArray([]),w.radius=ko.observable(2e3),w.keyword=ko.observable(""),w.placeReviews=ko.observableArray([]),w.placePhotos=ko.observableArray([]),w.placeInFocus=ko.observable(),w.address=function(e){return e.vicinity?e.vicinity:e.formatted_address},w.icons=ko.computed(function(){var e=new Set,n=[];for(var t in w.nearByPlaces())t&&e.add(w.nearByPlaces()[t].icon);return e.forEach(function(e){n.push({icon:e})}),n.slice(0,8)}),w.rateImg=function(e){for(var n=Math.round(2*e.rating)/2,t=[],o=0;o<parseInt(n);o++)t.push({star:"images/full-star.png"});for(n-parseInt(n)!==0&&t.push({star:"images/half-star.png"}),o=0;o<parseInt(5-n);o++)t.push({star:"images/empty-star.png"});return t},w.displayedPlaces=function(){var e=[],n=w.keyword().toLowerCase(),t=[],o=window.innerWidth;if(t=w.places().length<2?w.nearByPlaces():w.places(),""!==w.keyword())for(var i in t)(-1!=t[i].name.toLowerCase().indexOf(n)||-1!=t[i].types[0].toLowerCase().indexOf(n))&&(b=null,e.push(t[i]));else e=500>o?t.slice(0,12):t;return s(e),e},w.formattedType=function(e){var n=e.types[0].replace(/[_-]/g," ");return n.charAt(0).toUpperCase()+n.substr(1,n.length)},e(),n(),a(),w.clickMarker=function(e){var n=e.name.toLowerCase();w.markers().forEach(function(e){e.title.toLowerCase()===n&&google.maps.event.trigger(e,"click"),console.log("zoom: ",f.getZoom())})},$("#filters").on("click","button",function(){w.places([]),b=google.maps.Animation.DROP;var e=$(this).children("img").attr("src").split("/"),n=e[e.length-1].split("-")[0];k=[],"fitness"==n&&k.push("gym");for(var t in googlePlaceTypes)-1!=googlePlaceTypes[t].toLowerCase().indexOf(n.substring(0,4))&&k.push(googlePlaceTypes[t]);o(f.getCenter())}),$("#reset").on("click",function(){w.places([]),k=[],o(f.getCenter())}),$("#prev-list").children().hide(),$("#prev-list").children().click(function(){var e=$(".infolist").scrollLeft()/(x-26);h(e===parseInt(e,10)?-1:0)}),$("#next-list").children().click(function(){h(1)}),$(".infolist").scroll(function(){$(this).scrollLeft()<x/3?$("#prev-list").children().hide():$(this).scrollLeft()>($(this).children("li").length-2)*x?$("#next-list").children().hide():($("#prev-list").children().show(),$("#next-list").children().show())}),$(".col-md-8").css("width",x-2*($(".navigator").width()+26)),$(window).width()<800&&$(".row").css("width",x);var L=0,P=$(".infolist");setInterval(function(){var e=P.children("li").length,n=P.scrollLeft()/(x-26);n>e-2||n!==parseInt(n,10)&&(L>n?h(0):n>L&&h(1),L=Math.round(n))},1200)}ko.applyBindings(new e),$("#hide").click(function(){var e="",n=$(this).children("span").attr("class");e="left"===n.slice(29)?n.replace("left","right"):n.replace("right","left"),$(this).siblings("div").animate({width:"toggle"},500),$(this).children("span").attr("class",e)})});